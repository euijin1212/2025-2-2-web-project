<%- include('partials/header') %>

<div class="container mt-4">
  <h2 class="mb-3"><%= study.title %> - 스터디 홈</h2>

  <p class="text-muted mb-2">
    개설자: <%= study.creatorName || '알 수 없음' %> |
    나의 역할: <%= role === 'LEADER' ? '리더' : '멤버' %>
  </p>

  <!-- 상단: 책 정보 + 요약 -->
  <div class="row mb-4">
    <div class="col-md-4">
      <% if (study.bookCoverUrl) { %>
        <img src="<%= study.bookCoverUrl %>" class="img-fluid rounded" alt="책 표지">
      <% } else { %>
        <div class="bg-light border rounded d-flex align-items-center justify-content-center"
             style="width:100%; height:200px;">
          <span class="text-muted">책 표지 없음</span>
        </div>
      <% } %>
    </div>

    <div class="col-md-8">
      <% if (study.bookTitle) { %>
        <p class="mb-1">📚 <strong><%= study.bookTitle %></strong></p>
      <% } %>
      <% if (study.bookAuthor) { %>
        <p class="mb-2">✍️ <%= study.bookAuthor %></p>
      <% } %>

      <p class="mb-2">
        <% if (study.day) { %>
          <span class="badge bg-secondary">
            요일:
            <% if (study.day === 'mon') { %>월<% } %>
            <% if (study.day === 'tue') { %>화<% } %>
            <% if (study.day === 'wed') { %>수<% } %>
            <% if (study.day === 'thu') { %>목<% } %>
            <% if (study.day === 'fri') { %>금<% } %>
            <% if (study.day === 'sat') { %>토<% } %>
            <% if (study.day === 'sun') { %>일<% } %>
          </span>
        <% } %>
        <span class="badge bg-info text-dark">
          최대 <%= study.maxMembers %>명
        </span>
      </p>

      <p style="white-space:pre-line;" class="mt-3">
        <strong>스터디 소개</strong><br>
        <%= study.description %>
      </p>
    </div>
  </div>

  <!-- 📌 책 요약 (Gemini) -->
  <div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="mb-0">📌 책 요약 (AI)</h4>
      <button id="btn-summary" class="btn btn-sm btn-outline-primary">
        요약 불러오기
      </button>
    </div>
    <div id="summary-box" class="border rounded p-3 bg-light" style="min-height:80px;">
      <span class="text-muted">아직 요약이 없습니다. "요약 불러오기"를 눌러주세요.</span>
    </div>
  </div>

  <hr>

  <div class="row">
    <!-- 📝 게시판 -->
    <div class="col-md-7 mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">📝 게시판</h4>
        <div>
          <a href="/studies/<%= study.id %>/board" class="btn btn-sm btn-outline-secondary me-2">
            전체보기
          </a>
          <a href="/studies/<%= study.id %>/board/new" class="btn btn-sm btn-primary">
            글쓰기
          </a>
        </div>
      </div>

      <% if (recentPosts && recentPosts.length > 0) { %>
        <ul class="list-group">
          <% recentPosts.forEach(post => { %>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <a href="/studies/<%= study.id %>/board/<%= post.id %>">
                  <strong><%= post.title %></strong>
                </a><br>
                <small class="text-muted">
                  by <%= post.authorName || '알 수 없음' %> · 
                  <%= post.createdAt.toISOString().slice(0, 10) %>
                </small>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <div class="border rounded p-3 bg-light">
          <span class="text-muted">아직 작성된 게시글이 없습니다. 첫 글을 작성해보세요.</span>
        </div>
      <% } %>
    </div>

    <!-- 💬 채팅 입장 버튼 (페이지 분리 예정) -->
    <div class="col-md-5 mb-4">
      <h4>💬 실시간 채팅</h4>
      <p class="text-muted small">스터디 시간에 함께 이야기 나누는 공간입니다.</p>

      <div class="border rounded p-3 bg-light" style="height:200px;">

        <a href="/studies/<%= study.id %>/chat" class="btn btn-outline-primary btn-sm">
          채팅방 입장
        </a>
      </div>
    </div>
  </div>

  <a href="/dashboard" class="btn btn-outline-secondary mt-3">← 내 대시보드</a>
  <a href="/studies" class="btn btn-outline-secondary mt-3 ms-2">스터디 목록</a>
</div>

<script>
  // 📌 책 요약 버튼 -> Gemini API 라우트 호출
  document.getElementById('btn-summary')?.addEventListener('click', async () => {
    const box = document.getElementById('summary-box');
    box.innerHTML = '<span class="text-muted">요약 생성 중...</span>';

    try {
      const res = await fetch('/studies/<%= study.id %>/ai/summary', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        box.innerHTML = '<span class="text-danger">요약 생성에 실패했습니다.</span>';
        return;
      }

      const data = await res.json();
      box.textContent = data.summary || '요약 결과가 없습니다.';
    } catch (e) {
      console.error(e);
      box.innerHTML = '<span class="text-danger">요약 요청 중 오류가 발생했습니다.</span>';
    }
  });
</script>

<%- include('partials/footer') %>
