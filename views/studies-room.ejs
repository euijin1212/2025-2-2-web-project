<%- include('partials/header') %>

<!-- Header -->
<div class="mb-2 p-4 rounded-3">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h2 class="mb-0 d-flex align-items-center" style="color: #2d3748; font-weight: 700;">
            <img src="/images/home.png" alt="study-home" class="icon-png"><%= study.title %>
        </h2>
        <p class="mb-0 d-none d-md-block" style="color: #2d3748; font-weight: 600; font-size: 1.05rem;">
            개설자: <%= study.creatorName || '알 수 없음' %> |
            나의 역할: <%= role === 'LEADER' ? '리더' : '멤버' %>
        </p>
    </div>
</div>

<!-- 책 정보 -->
<div class="row mb-4">
    <div class="col-lg-3">
        <div class="book-cover-container h-100">
            <% if (study.bookCoverUrl) { %>
                <img src="<%= study.bookCoverUrl %>" alt="책 표지">
            <% } else { %>
                <div class="bg-light border rounded d-flex align-items-center justify-content-center"
                        style="width:100%; height:450px;">
                    <span class="text-muted">책 표지 없음</span>
                </div>
            <% } %>
        </div>
    </div>

    <div class="col-lg-9">
        <div class="book-info-card h-100 d-flex flex-column">

            <div style="background: rgba(102, 126, 234, 0.05); padding: 1rem 1.5rem; border-radius: 12px; border-left: 4px solid #667eea;">
                <% if (study.bookTitle) { %>
                    <p class="mb-2" style="font-size: 1.3rem;">
                        <strong><%= study.bookTitle %></strong>
                    </p>
                <% } %>
                <% if (study.bookAuthor) { %>
                    <p class="mb-3" style="font-size: 1.05rem; color: #718096;">
                        <%= study.bookAuthor %>
                    </p>
                <% } %>
            </div>

            <div class="ms-3 mb-3 mt-3">
                <p style="color: #2d3748;"><%= study.description %></p>
            </div>

            <div class="mt-auto">
                <% if (study.day) { %>
                    <span class="badge-day me-2">
                        요일:
                        <% if (study.day === 'mon') { %>월요일<% } %>
                        <% if (study.day === 'tue') { %>화요일<% } %>
                        <% if (study.day === 'wed') { %>수요일<% } %>
                        <% if (study.day === 'thu') { %>목요일<% } %>
                        <% if (study.day === 'fri') { %>금요일<% } %>
                        <% if (study.day === 'sat') { %>토요일<% } %>
                        <% if (study.day === 'sun') { %>일요일<% } %>
                    </span>
                <% } %>
                <span class="badge-members">
                    정원: <%= study.maxMembers %>명
                </span>
            </div>
        </div>
    </div>
</div>

<!-- 책 요약 -->
<div class="summary-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">📌 책 요약 (AI)</h4>
        <button id="btn-summary">
            <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px; vertical-align: -3px;">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/>
            </svg>
            요약 불러오기
        </button>
    </div>
    <div id="summary-box" style="min-height:100px;">
        <span style="color: #718096;">아직 요약이 없습니다. "요약 불러오기"를 눌러주세요.</span>
    </div>
</div>

<div class="row">
    <!-- 게시판 -->
    <div class="col-lg-7 mb-4">
        <div class="board-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">📝 게시판</h4>
                <div>
                    <a href="/studies/<%= study.id %>/board" class="btn btn-sm btn-board-view me-2">
                        전체보기
                    </a>
                    <a href="/studies/<%= study.id %>/board/new" class="btn btn-sm btn-board-write">
                        글쓰기
                    </a>
                </div>
            </div>

            <% if (recentPosts && recentPosts.length > 0) { %>
                <ul class="list-group">
                    <% recentPosts.forEach(post => { %>
                        <li class="list-group-item" style="border-left: 3px solid #667eea;">
                            <div>
                                <a href="/studies/<%= study.id %>/board/<%= post.id %>" style="color: #2d3748; font-weight: 600; text-decoration: none;">
                                    <%= post.title %>
                                </a><br>
                                <small style="color: #718096;">
                                    by <%= post.authorName || '알 수 없음' %> ·
                                    <%= post.createdAt.toISOString().slice(0, 10) %>
                                </small>
                            </div>
                        </li>
                    <% }) %>
                </ul>
            <% } else { %>
                <div style="background: rgba(102, 126, 234, 0.05); border-radius: 12px; padding: 2rem; text-align: center;">
                    <span style="color: #718096;">아직 작성된 게시글이 없습니다. 첫 글을 작성해보세요!</span>
                </div>
            <% } %>
        </div>
    </div>

    <!-- 채팅 -->
    <div class="col-lg-5 mb-4">
        <div class="chat-section">
            <h4>💬 실시간 채팅</h4>
            <p>스터디 시간에 함께 이야기 나누는 공간입니다.</p>

            <div style="background: linear-gradient(135deg, rgba(250, 112, 154, 0.1) 0%, rgba(254, 225, 64, 0.1) 100%);
                        border-radius: 12px;
                        padding: 3rem 2rem;
                        text-align: center;
                        border: 2px dashed rgba(250, 112, 154, 0.3);">
                <svg width="60" height="60" fill="currentColor" viewBox="0 0 16 16" style="color: #fa709a; margin-bottom: 1rem;">
                    <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                </svg>
                <br>
                <a href="/studies/<%= study.id %>/chat" class="btn-chat-enter">
                    채팅방 입장하기
                </a>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="/dashboard" class="btn btn-board-view" style="padding: 0.75rem 1.5rem;">
        ← 내 대시보드
    </a>
    <a href="/studies" class="btn btn-board-write ms-2" style="padding: 0.75rem 1.5rem;">
        스터디 목록
    </a>
</div>

<script>
    document.getElementById('btn-summary')?.addEventListener('click', async () => {
        const box = document.getElementById('summary-box');
        box.innerHTML = '<span style="color: #667eea; font-weight: 500;">요약 생성 중...</span>';

        try {
            const res = await fetch('/studies/<%= study.id %>/ai/summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!res.ok) {
                box.innerHTML = '<span style="color: #f5576c; font-weight: 500;">요약 생성에 실패했습니다.</span>';
                return;
            }

            const data = await res.json();
            box.textContent = data.summary || '요약 결과가 없습니다.';
        } catch (e) {
            console.error(e);
            box.innerHTML = '<span style="color: #f5576c; font-weight: 500;">요약 요청 중 오류가 발생했습니다.</span>';
        }
    });
</script>

<%- include('partials/footer') %>