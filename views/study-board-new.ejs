<%- include('partials/header') %>

<div class="container mt-4">
  <h2 class="mb-3"><%= study.title %> - ê¸€ì“°ê¸°</h2>

  <form action="/studies/<%= study.id %>/board" method="POST">
    <div class="mb-3">
      <label for="title" class="form-label">ì œëª©</label>
      <div class="input-group">
        <input type="text" id="title" name="title" class="form-control" required>
        <button type="button" id="btn-topic" class="btn btn-outline-secondary">
          AI í† ë¡  ì£¼ì œ ì¶”ì²œ
        </button>
      </div>
    </div>

    <div class="mb-3">
      <label for="content" class="form-label">ë‚´ìš©</label>
      <textarea id="content" name="content" rows="10" class="form-control" required></textarea>
    </div>

    <div class="d-flex justify-content-between">
      <a href="/studies/<%= study.id %>/board" class="btn btn-outline-secondary">
        ëª©ë¡ìœ¼ë¡œ
      </a>
      <button type="submit" class="btn btn-primary">ë“±ë¡</button>
    </div>
  </form>
</div>

<script>
  // ğŸ“Œ í† ë¡  ì£¼ì œ ì¶”ì²œ ë²„íŠ¼ -> Gemini í˜¸ì¶œ ë¼ìš°íŠ¸
  document.getElementById('btn-topic')?.addEventListener('click', async () => {
    const btn = document.getElementById('btn-topic');
    btn.disabled = true;
    btn.textContent = 'ìƒì„± ì¤‘...';

    try {
      const res = await fetch('/studies/<%= study.id %>/ai/topics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        alert('í† ë¡  ì£¼ì œ ìƒì„± ì‹¤íŒ¨');
        btn.disabled = false;
        btn.textContent = 'AI í† ë¡  ì£¼ì œ ì¶”ì²œ';
        return;
      }

      const data = await res.json();
      const topics = data.topics || [];

      if (topics.length === 0) {
        alert('ìƒì„±ëœ í† ë¡  ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
      } else {
        const titleInput = document.getElementById('title');
        const contentArea = document.getElementById('content');

        // ì²« ë²ˆì§¸ ì£¼ì œë¥¼ ì œëª©ì—, ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‚´ìš© ì•ë¶€ë¶„ì— ì¶”ê°€
        titleInput.value = topics[0];
        const prefix = 'ğŸ“Œ AI ì¶”ì²œ í† ë¡  ì£¼ì œ:\n' + topics.map((t, i) => `${i+1}. ${t}`).join('\n') + '\n\n';
        contentArea.value = prefix + contentArea.value;
      }
    } catch (e) {
      console.error(e);
      alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'AI í† ë¡  ì£¼ì œ ì¶”ì²œ';
    }
  });
</script>

<%- include('partials/footer') %>
