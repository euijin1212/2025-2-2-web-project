<%- include('partials/header') %>

<style>
  .board-new-container {
    max-width: 900px;
    margin: 2rem auto;
  }

  .board-new-header {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .board-new-header h2 {
    color: #2d3748;
    font-weight: 700;
    margin: 0;
  }

  .btn-ai-topic {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    border-radius: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);
    white-space: nowrap;
  }

  .btn-ai-topic:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(250, 112, 154, 0.4);
    color: white;
  }
</style>

<div class="container board-new-container">
  <div class="board-new-header">
    <h2><%= study.title %> - ê¸€ì“°ê¸°</h2>
  </div>

  <form action="/studies/<%= study.id %>/board" method="POST">
    <div class="mb-3">
      <label for="title" class="form-label" style="color: #2d3748; font-weight: 600;">ì œëª©</label>
      <div class="input-group">
        <input type="text" id="title" name="title" class="form-control" required style="border: 2px solid #e2e8f0; border-radius: 12px 0 0 12px; padding: 1rem; font-size: 1rem;">
        <button type="button" id="btn-topic" class="btn-ai-topic" style="border-radius: 0 12px 12px 0;">
          <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px; vertical-align: -3px;">
            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
            <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
          </svg>
          AI í† ë¡  ì£¼ì œ ì¶”ì²œ
        </button>
      </div>
    </div>

    <div class="mb-3">
      <label for="content" class="form-label" style="color: #2d3748; font-weight: 600;">ë‚´ìš©</label>
      <textarea id="content" name="content" rows="10" class="form-control" required style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem; font-size: 1rem;"></textarea>
    </div>

    <div class="d-flex justify-content-between">
      <a href="/studies/<%= study.id %>/board" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); text-decoration: none;">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px; vertical-align: -3px;">
          <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
        ëª©ë¡ìœ¼ë¡œ
      </a>
      <button type="submit" class="btn" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);">
        <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px; vertical-align: -3px;">
          <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2zm10.03 4.97a.75.75 0 0 1 .011 1.05l-3.992 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.75.75 0 0 1 1.08-.022z"/>
        </svg>
        ë“±ë¡
      </button>
    </div>
  </form>
</div>

<script>
  // ğŸ“Œ í† ë¡  ì£¼ì œ ì¶”ì²œ ë²„íŠ¼ -> Gemini í˜¸ì¶œ ë¼ìš°íŠ¸
  document.getElementById('btn-topic')?.addEventListener('click', async () => {
    const btn = document.getElementById('btn-topic');
    btn.disabled = true;
    btn.textContent = 'ìƒì„± ì¤‘...';

    try {
      const res = await fetch('/studies/<%= study.id %>/ai/topics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      if (!res.ok) {
        alert('í† ë¡  ì£¼ì œ ìƒì„± ì‹¤íŒ¨');
        btn.disabled = false;
        btn.textContent = 'AI í† ë¡  ì£¼ì œ ì¶”ì²œ';
        return;
      }

      const data = await res.json();
      const topics = data.topics || [];

      if (topics.length === 0) {
        alert('ìƒì„±ëœ í† ë¡  ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
      } else {
        const titleInput = document.getElementById('title');
        const contentArea = document.getElementById('content');

        // ì²« ë²ˆì§¸ ì£¼ì œë¥¼ ì œëª©ì—, ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‚´ìš© ì•ë¶€ë¶„ì— ì¶”ê°€
        titleInput.value = topics[0];
        const prefix = 'ğŸ“Œ AI ì¶”ì²œ í† ë¡  ì£¼ì œ:\n' + topics.map((t, i) => `${i+1}. ${t}`).join('\n') + '\n\n';
        contentArea.value = prefix + contentArea.value;
      }
    } catch (e) {
      console.error(e);
      alert('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'AI í† ë¡  ì£¼ì œ ì¶”ì²œ';
    }
  });
</script>

<%- include('partials/footer') %>
