<%- include('partials/header') %>

<div class="container mt-4">
  <h2><%= study.title %> - 채팅방</h2>
  <p class="text-muted">스터디 멤버들과 실시간으로 대화해보세요.</p>

  <!-- 채팅 로그 -->
  <div id="chat-box"
       class="border rounded p-3 mb-3"
       style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
    <% if (messages && messages.length > 0) { %>
      <% messages.forEach(function(m) { %>
        <div class="mb-1">
          <strong><%= m.nickname || '알 수 없음' %></strong>
          <small class="text-muted">
            (<%= m.createdAtFormatted %>)
          </small>
          <div><%= m.message %></div>
        </div>
      <% }) %>
    <% } else { %>
      <div class="text-muted">아직 대화가 없습니다. 첫 메시지를 보내보세요!</div>
    <% } %>
  </div>

  <!-- 입력 폼 -->
  <form id="chat-form" class="d-flex gap-2">
    <input id="chat-input"
           type="text"
           class="form-control"
           placeholder="메시지를 입력하세요..."
           autocomplete="off" />
    <button type="submit" class="btn btn-primary">전송</button>
  </form>

  <div class="mt-3">
    <a href="/studies/<%= study.id %>/room" class="btn btn-outline-secondary btn-sm">
      ← 스터디 홈으로
    </a>
    <a href="/studies/<%= study.id %>/board" class="btn btn-outline-secondary btn-sm">
      게시판 바로가기
    </a>
  </div>
</div>

<!-- Socket.IO 클라이언트 -->
<script src="/socket.io/socket.io.js"></script>
<script>
  (function() {
    const studyId  = '<%= study.id %>';
    const userId   = "<%= user ? user.id : '' %>";
    const nickname = "<%= user ? user.nickname : '' %>";

    // 서버에 연결
    const socket = io({
      query: {
        studyId,
        userId,
        nickname
      }
    });

    const chatBox  = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const chatInput= document.getElementById('chat-input');

    // 서버에서 온 메시지 표시
    socket.on('chatMessage', function(data) {
      const div = document.createElement('div');
      div.classList.add('mb-1');

      const name = data.nickname || '알 수 없음';
      const time = new Date(data.createdAt).toLocaleString();

      div.innerHTML =
        '<strong>' + escapeHtml(name) + '</strong> ' +
        '<small class="text-muted">(' + time + ')</small>' +
        '<div>' + escapeHtml(data.message) + '</div>';

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 메시지 전송
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;
      socket.emit('chatMessage', text);
      chatInput.value = '';
    });

    // XSS 방지용 간단 escape 함수
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function(m) {
        switch (m) {
          case '&': return '&amp;';
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '"': return '&quot;';
          case "'": return '&#39;';
        }
      });
    }
  })();
</script>

<%- include('partials/footer') %>
